:root{ --text-zoom: 1; --font-scale: 1; }
html{ font-size: calc(16px * var(--text-zoom) * var(--font-scale, 1)); }

:root, :host { color-scheme: light dark; }
*{ box-sizing:border-box }
html, body{ height:100% }

/* Fluid type – keeps headings legible without crowding cards */
:root{
  --step-0: clamp(.95rem, .85rem + .4vw, 1.05rem);
  --step-1: clamp(1.05rem, .9rem + .7vw, 1.35rem);
  --step-2: clamp(1.25rem, 1rem + 1.2vw, 1.8rem);
}

body{ margin:0; font: 400 1rem/1.55 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; padding-bottom: calc(var(--topbar-h, 56px) + var(--rail-safe, 0px)); }

.rf-page{ --content-max: 1600px; width:min(100%, var(--content-max)); margin:0 auto; padding:var(--space-lg); }

:root{
  /* Spacing tokens */
  --space-xxs: calc(2px  * var(--font-scale, 1));
  --space-xs:  calc(4px  * var(--font-scale, 1));
  --space-sm:  calc(8px  * var(--font-scale, 1));
  --space-md:  calc(12px * var(--font-scale, 1));
  --space-lg:  calc(16px * var(--font-scale, 1));
  --space-xl:  calc(24px * var(--font-scale, 1));
  --space-2xl: calc(32px * var(--font-scale, 1));
  --space-tight: calc(var(--space-sm) - var(--space-xxs));    /* ≈ 6px */
  --space-snug:  calc(var(--space-md) - var(--space-xxs));    /* ≈10px */

  /* Control sizing */
  --control-size: calc(44px * var(--font-scale, 1));
  --control-sm:   calc(36px * var(--font-scale, 1));
  --control-xs:   calc(28px * var(--font-scale, 1));
  --icon-size:    calc(18px * var(--font-scale, 1));
  --avatar-lg:    calc(36px * var(--font-scale, 1));
  --avatar-md:    calc(32px * var(--font-scale, 1));
  --avatar-sm:    calc(28px * var(--font-scale, 1));
  --avatar-xs:    calc(22px * var(--font-scale, 1));

  /* Radius tokens */
  --radius-sm: 8px;
  --radius-md: 12px;
  --radius-lg: 14px;
  --radius-full: 999px;

  /* Colors */
  --bg-0:#eef1f8; --bg-1:#ffffff; --bg-2:#e3e7f5;
  --text:#111827; --muted:#334155; --border:#c8d2f0; --shadow-rgb:15 23 42;
  --brand-red:#c61e1f; --brand-red-ink:#a01516; --brand-graphite:#475569;
  --brand-navy:#1e3a8a; --brand-sky:#2563eb;
  --link:#1d4ed8; --link-visited:#6e3ee6; --focus:#00c2ff;
  --ok:#0f9d58; --warn:#f59e0b; --danger:#dc2626; --info:#2563eb;
  --accent: var(--brand-red);

  /* Calendar tokens (Light + Dark + HC) */
  --cal-bg: var(--bg-0);
  --cal-day: var(--bg-0);
  --cal-day-border: var(--border);
  --cal-num: color-mix(in oklab, var(--text) 92%, black);     /* higher contrast numerals */
  --cal-muted: color-mix(in oklab, var(--text) 60%, transparent);
  --cal-focus: color-mix(in oklab, var(--accent) 60%, black); /* focus ≥3:1 */
}

/* ---------- LIGHTVIM (WCAG AA+) ---------- */
:root[data-theme="LightVim"]{
  /* Surfaces */
  --bg-0: oklch(0.98 0.01 240);   /* page */
  --bg-1: oklch(0.97 0.01 240);   /* cards */
  --bg-2: oklch(0.94 0.01 240);   /* headers/stripes */
  --elev: color-mix(in oklab, var(--bg-1) 84%, white);

  /* Text */
  --ink-0: #111111;              /* primary text */
  --ink-1: #1f2937;              /* labels / captions */
  --ink-2: #4b5563;              /* muted text */
  --text: var(--ink-0);
  --muted: var(--ink-1);

  /* Borders / outlines */
  --border: oklch(0.86 0.01 245);
  --border-strong: oklch(0.78 0.02 245);
  --focus: oklch(0.69 0.13 280);  /* visible on light+dark */

  /* Accents (brand) */
  --brand:   oklch(0.64 0.22 30);   /* warm red (Reclame badge) */
  --brand-2: oklch(0.62 0.06 80);   /* cube sand/beige */
  --accent-1: var(--brand);
  --accent-2: var(--brand-2);
  --chip: var(--ink-0);

  /* States */
  --ok:      oklch(0.74 0.14 150);
  --warn:    oklch(0.83 0.12 80);
  --error:   oklch(0.62 0.20 20);
  --danger:  var(--error);
  --link:    oklch(0.56 0.17 260);

  --shadow-rgb: 15 23 42;
  color-scheme: light;
}
:root[data-theme="DarkVim"]{
  /* Surfaces */
  --bg-0:#0f172a; --bg-1:#131c2f; --bg-2:#1c2942;
  --elev: color-mix(in oklab, var(--bg-1) 84%, white);
  
  /* Text */
  --text:#f8fafc; --muted:#cbd5f5;
  
  /* Borders / outlines */
  --border:#314165;
  --border-strong: #3f5078;
  --focus: oklch(0.69 0.13 280);
  
  /* Accents (brand) */
  --brand: #ff6d6e;
  --brand-2: #8fb4ff;
  --accent-1:#ff6d6e; --accent-2:#8fb4ff; --chip:#dbe5ff;
  
  /* States */
  --ok: #10b981;
  --warn: #fbbf24;
  --error: #ef4444;
  --danger: var(--error);
  --link: #60a5fa;
  
  --shadow-rgb:2 6 23;
  color-scheme: dark;
}
:root[data-theme="HighContrast"]{
  /* Surfaces */
  --bg-0:#000; --bg-1:#090909; --bg-2:#151515;
  --elev: #1a1a1a;
  
  /* Text */
  --text:#fff; --muted:#f5f5f5;
  
  /* Borders / outlines */
  --border:#fff;
  --border-strong: #fff;
  --focus: #00ffff;
  
  /* Accents (brand) */
  --brand: #ff3b3c;
  --brand-2: #f0dfc8;
  --accent-1:#ff3b3c; --accent-2:#f0dfc8; --chip:#fff;
  
  /* States */
  --ok: #00ff00;
  --warn: #ffff00;
  --error: #ff0000;
  --danger: var(--error);
  --link: #00ffff;
  
  --shadow-rgb:0 0 0;
  color-scheme: dark;
}

/* Global text & backgrounds use the tokens above */
body{ color:var(--ink-0, var(--text)); background:var(--bg-0); }
.rf-page .card{ background:var(--bg-1); border:1px solid var(--border); }
.muted{ color:var(--ink-2, var(--muted)); }
a{ color:var(--link); }
.tag, .chip, .icon{
  color:var(--ink-0, var(--text));
  background:var(--bg-1);
  border:1px solid var(--border);
}

/* Calendar specifics (fix invisible labels) */
.cal-day .label,
.cal-day .meta,
.cal-legend span{ color:var(--ink-1, var(--muted)); }
.cal-day{ background:var(--bg-1); border:1px dashed var(--border); }
.cal-day[aria-current="date"]{ border-color:var(--border-strong, var(--border)); }
.cal-day .badge{ background:var(--elev, var(--bg-1)); color:var(--ink-0, var(--text)); border:1px solid var(--border); }

/* Buttons: readable in light theme */
.tag.primary{
  background:var(--brand, var(--accent-1));
  color:var(--ink-0, var(--text));
  border-color:color-mix(in oklab,var(--brand, var(--accent-1)) 80%, var(--ink-0, var(--text)));
}
.tag.ghost{ background:transparent; color:var(--ink-0, var(--text)); border-color:var(--border); }

/* Calendar-specific styling for Light mode */
.cal .day-num { color: var(--cal-num); }
.cal .day:focus-visible { outline: 3px solid var(--cal-focus); outline-offset: 2px; }

body{ background:var(--bg-0); color:var(--text) }
a{ color:var(--link); text-decoration:underline; text-underline-offset:2px }
a:visited{ color:var(--link-visited) }
:focus-visible{ outline:2px solid var(--focus); outline-offset:2px; border-radius:var(--radius-sm) }

.rf-scroll{ overflow:auto; min-height:0; width:100%; display:block; }
.rf-scroll > table,
.rf-scroll > .rf-table,
.rf-scroll .rf-table{ width:100%; border-collapse:collapse; }

/* Improved card styling */
.card, .rf-panel{
  background:var(--bg-1);
  border:1px solid color-mix(in oklab,var(--border) 85%, transparent);
  border-radius:var(--radius-lg);
  box-shadow:0 16px 32px rgba(var(--shadow-rgb)/.12);
}
.card{ padding:var(--space-lg); container-type: inline-size; container-name: card; }

/* Improved tag/button styling */
.tag{
  display:inline-flex;
  align-items:center;
  gap:var(--space-sm);
  padding:var(--space-sm) var(--space-md);
  border-radius:var(--radius-full);
  border:1px solid color-mix(in oklab,var(--border) 90%, transparent);
  background:color-mix(in oklab,var(--bg-1) 55%, var(--bg-2) 45%);
  color:var(--text);
  text-decoration:none;
  white-space:nowrap;
  cursor:pointer;
  transition:background .2s ease, border-color .2s ease, color .2s ease, transform .2s ease
}
.tag :where(svg){
  width:var(--icon-size);
  height:var(--icon-size);
}
.tag:hover{
  background:color-mix(in oklab,var(--bg-2) 70%, var(--bg-1) 30%);
  transform:translateY(-1px);
}
.tag.is-active{
  background:linear-gradient(135deg,var(--accent-1),color-mix(in oklab,var(--accent-1) 70%, var(--accent-2)));
  color:var(--ink-0, var(--text));
  border-color:color-mix(in oklab,var(--accent-1) 60%, transparent)
}

.rf-btn, button:not(.tag){
  background:linear-gradient(135deg,var(--accent-1),color-mix(in oklab,var(--accent-1) 70%, var(--accent-2)));
  color:var(--ink-0, var(--text));
  border:none;
  border-radius:var(--radius-md);
  padding:var(--space-sm) var(--space-lg);
  font-weight:600;
  cursor:pointer;
  transition:transform .2s ease, box-shadow .2s ease;
}
.rf-btn:hover, button:not(.tag):hover{
  transform:translateY(-1px);
  box-shadow:0 8px 16px rgba(var(--shadow-rgb)/.16);
}

button.icon{
  width:var(--control-size);
  height:var(--control-size);
  min-width:var(--control-size);
  min-height:var(--control-size);
  display:inline-flex;
  align-items:center;
  justify-content:center;
  border-radius:var(--radius-md);
  border:1px solid color-mix(in oklab,var(--border) 80%, transparent);
  background:var(--bg-0);
  color:var(--text);
}
:where(button.icon svg){
  width:var(--icon-size);
  height:var(--icon-size);
}

.menu{ position:relative; }
.menu .dropdown{
  position:absolute;
  top:calc(100% + var(--space-sm));
  right:0;
  display:none;
  min-width:calc(160px * var(--font-scale, 1));
  border-radius:var(--radius-md);
  border:1px solid var(--border);
  background:var(--bg-1);
  box-shadow:0 12px 24px rgba(var(--shadow-rgb)/.18);
  padding:var(--space-sm);
  z-index:10;
}
.menu:focus-within .dropdown,
.menu:hover .dropdown{ display:grid; gap:calc(var(--space-sm) - var(--space-xxs)); }
.menu .dropdown button{
  border:none;
  border-radius:var(--radius-md);
  padding:var(--space-sm) calc(var(--space-sm) + var(--space-xxs));
  background:transparent;
  text-align:left;
  cursor:pointer;
}
.menu .dropdown button:hover{
  background:color-mix(in oklab,var(--bg-2) 70%, var(--bg-1) 30%);
}

.badge{
  background:var(--accent);
  color:var(--ink-0, var(--text));
  border-radius:var(--radius-full);
  padding:var(--space-xxs) calc(var(--space-sm) - var(--space-xxs));
  margin-left:calc(var(--space-sm) - var(--space-xxs));
  font-size:0.75rem;
}

.dropdown{animation:fade .18s ease}
@keyframes fade{from{opacity:0;transform:translateY(-4px)}to{opacity:1;transform:translateY(0)}}

/* Density tokens */
:root{ --density:cozy; --space: calc(10px * var(--font-scale, 1)); } /* default */
:root[data-density="compact"]      { --density:compact;      --space: calc(6px  * var(--font-scale, 1)); }
:root[data-density="cozy"]         { --density:cozy;         --space: calc(10px * var(--font-scale, 1)); }
:root[data-density="comfortable"]  { --density:comfortable;  --space: calc(14px * var(--font-scale, 1)); }

.grid{ gap: var(--space); }
.row{
  display:flex;
  flex-wrap:wrap;
  gap: var(--space);
  align-items:center;
}
.card{ padding: calc(var(--space) + 2px); }
.rf-table .rowi > *{ padding-block: calc(var(--space) * .25); }

/* Sticky headers */
.sticky-top{ position:sticky; top: calc(var(--topbar-h) + var(--space-sm)); z-index: 5; background:var(--bg-0); }
.cal-header{ position:sticky; top: calc(var(--topbar-h) + var(--space-sm)); z-index:4; background:var(--bg-0); }

/* ========== FIX PACK: CSS TOKENS & LAYERING ========== */

/* Layout constants */
:root{ --topbar-h: calc(56px * var(--font-scale, 1)); }

/* Dropdown layering and shape */
.menu > .dropdown{
  z-index: 9999;
  background: var(--bg-1);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: 0 8px 32px color-mix(in oklab, black 14%, transparent);
  padding: calc(var(--space-sm) - var(--space-xxs));
  min-width: calc(220px * var(--font-scale, 1));
}

/* Stronger header/legend contrast in Light */
:root[data-theme="LightVim"] .muted { color: var(--ink-1); } /* darker captions */
:root[data-theme="LightVim"] .cal-month-title,
:root[data-theme="LightVim"] .cal-day .label { color: var(--ink-0); }
:root[data-theme="LightVim"] .cal .head,
:root[data-theme="LightVim"] .legend__item { color: var(--ink-1); } /* darker calendar headers */
:root[data-theme="LightVim"] .cell__date { color: var(--ink-0); } /* ensure date numbers are dark */
:root[data-theme="LightVim"] .cell__row { color: var(--ink-1); } /* calendar cell metadata */
:root[data-theme="LightVim"] .rf-topbar nav.main a { color: var(--ink-0); } /* ensure navbar links are visible */

/* Sticky helpers that respect topbar */
.sticky-top  { position: sticky; top: calc(var(--topbar-h) + var(--space-sm)); z-index: 5; background: var(--bg-0); }
.cal-header  { position: sticky; top: calc(var(--topbar-h) + var(--space-sm)); z-index: 4; background: var(--bg-0); }

/* Sort caret & header focus */
.table thead th button.tag.ghost{
  outline-offset: 2px;
}
.table thead th button.tag.ghost[data-sort="asc"]::after { content: " ▲"; }
.table thead th button.tag.ghost[data-sort="desc"]::after{ content: " ▼"; }

/* Safer overflow for menu parents */
.menu{ position: relative; overflow: visible; }

/* Consistent table row heights */
.table tbody tr.rowi > td{ padding-block: calc(var(--space)*.60); }
