Love it—let’s design the **Loading Dates** workflow end-to-end and begin the **actual Order Form** with materials/colors + PDF preview. Below is a **complete batch** you can drop into your SvelteKit app.

---

# 1) Loading Dates: data model + store

Admin can “mark” calendar days as **Loading Days** (with capacity/notes). Orders then pick from upcoming Loading Days.

### `src/lib/loading/loading-store.ts`

```ts
// Local demo store; swap with backend later
import { listOrders } from '$lib/order/signage-store';

export type LoadingDay = {
  id: string;            // YYYY-MM-DD
  date: string;          // YYYY-MM-DD
  capacity: number;      // max orders per day
  note?: string;
  active: boolean;       // marked as loading day
};

const KEY = 'rf_loading_days';
let DB: Record<string, LoadingDay> =
  typeof window !== 'undefined' ? JSON.parse(localStorage.getItem(KEY) || '{}') : {};

function persist() { if (typeof window !== 'undefined') localStorage.setItem(KEY, JSON.stringify(DB)); }

export function listAll(): LoadingDay[] {
  return Object.values(DB).sort((a, b) => a.date.localeCompare(b.date));
}
export function get(id: string): LoadingDay | null { return DB[id] ?? null; }

export function toggleDay(dateISO: string, defaults = { capacity: 6, note: '' }) {
  const id = dateISO;
  const existing = DB[id];
  if (existing) {
    existing.active = !existing.active;
  } else {
    DB[id] = { id, date: dateISO, capacity: defaults.capacity, note: defaults.note, active: true };
  }
  persist();
}

export function setCapacity(dateISO: string, capacity: number) {
  const d = DB[dateISO]; if (!d) return; d.capacity = Math.max(0, capacity); persist();
}
export function setNote(dateISO: string, note: string) {
  const d = DB[dateISO]; if (!d) return; d.note = note; persist();
}

export function upcoming(fromISO = new Date().toISOString().slice(0,10)) {
  return listAll().filter(d => d.active && d.date >= fromISO);
}

// derived usage = count of orders assigned to that loading date
export function usage(dateISO: string) {
  const orders = listOrders();
  const assigned = orders.filter(o => (o as any).loadingDate === dateISO).length;
  const cap = DB[dateISO]?.capacity ?? 0;
  return { assigned, capacity: cap, full: cap > 0 && assigned >= cap };
}
```

---

# 2) Order store: assign a Loading Day to an order

### `src/lib/order/signage-store.ts` (append)

```ts
import { getOrder as _get, createOrder as _create, addRevision as _addRev, setDefaultRevision as _setDef,
         openPR as _open, mergePR as _merge, closePR as _close } from './vcs-store';
import type { Order } from './types.signage';

// existing re-exports...
export { listOrders, getOrder, createOrder, addRevision, setDefaultRevision } from './vcs-store';

export function setLoadingDate(orderId: string, dateISO: string, admin = 'admin') {
  const o = _get(orderId) as unknown as Order | null; if (!o) return;
  // Record as an admin "station log" via change request for audit
  const prId = _open(orderId, { title:'Loading day assignment', author:admin, proposed:{ fields:[...o.fields], /* keep fields */ } });
  // apply directly to snapshot
  (o as any).loadingDate = dateISO;
  _merge(orderId, prId, admin);
}
```

> We set `order.loadingDate` directly and still produce a log (CR→Approve) for traceability.

---

# 3) Calendar month (Admin marks Loading Days)

### `src/lib/calendar/CalendarMonth.svelte`

```svelte
<script lang="ts">
  import { toggleDay, listAll, setCapacity, setNote, usage } from '$lib/loading/loading-store';
  import { onMount } from 'svelte';
  export let year: number;
  export let month: number; // 0-11
  export let adminMode = false; // when true, clicking toggles loading day
  let days: { d: Date; iso: string; inMonth: boolean }[] = [];
  let selectedISO: string | null = null;

  function toISO(d: Date) { return d.toISOString().slice(0,10); }

  function build() {
    days = [];
    const first = new Date(year, month, 1);
    const dow = first.getDay() || 7; // Monday=1..7
    const start = new Date(first);
    start.setDate(1 - (dow - 1));
    for (let i = 0; i < 42; i++) {
      const d = new Date(start); d.setDate(start.getDate() + i);
      days.push({ d, iso: toISO(d), inMonth: d.getMonth() === month });
    }
  }
  onMount(build); $: (year, month, adminMode, build());

  function clickDay(iso: string) {
    if (!adminMode) { selectedISO = iso; return; }
    toggleDay(iso);
    selectedISO = iso;
  }

  function meta(iso: string) {
    const u = usage(iso);
    const ld = listAll().find(x => x.id === iso);
    return { active: !!ld?.active, note: ld?.note || '', cap: ld?.capacity ?? 0, ...u };
  }
</script>

<div class="cal">
  <div class="head">
    <div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div><div>Sun</div>
  </div>
  <div class="grid">
    {#each days as d}
      {#key d.iso}
      {#if d.inMonth}
        <button
          class="cell"
          aria-pressed={meta(d.iso).active}
          data-active={meta(d.iso).active}
          on:click={() => clickDay(d.iso)}>
          <div class="date">{d.d.getDate()}</div>
          {#if meta(d.iso).active}
            <div class="badge" aria-label="Loading day">
              {meta(d.iso).assigned}/{meta(d.iso).capacity || '∞'}
            </div>
          {/if}
        </button>
      {:else}
        <div class="cell muted"></div>
      {/if}
      {/key}
    {/each}
  </div>
</div>

{#if adminMode && selectedISO}
  <div class="card" style="margin-top:10px">
    <h3 style="margin:0 0 8px 0">Loading day: {selectedISO}</h3>
    <div class="row" style="gap:8px;flex-wrap:wrap">
      <label>Capacity <input class="rf-input" type="number" min="0"
        value={meta(selectedISO).capacity}
        on:change={(e)=>setCapacity(selectedISO!, Number((e.target as HTMLInputElement).value))} /></label>
      <label>Note <input class="rf-input" type="text"
        value={meta(selectedISO).note}
        on:change={(e)=>setNote(selectedISO!, (e.target as HTMLInputElement).value)} /></label>
    </div>
  </div>
{/if}

<style>
.cal { display:grid; gap:8px }
.head { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; text-align:center; }
.grid { display:grid; grid-template-columns:repeat(7,1fr); gap:6px; }
.cell { position:relative; min-height:80px; border:1px solid rgba(255,255,255,.12); border-radius:10px; background:var(--bg-0); cursor:pointer; }
.cell[data-active="true"]{ outline:2px solid var(--brand-amber); }
.cell .date { position:absolute; top:6px; left:8px; font-weight:700 }
.cell .badge { position:absolute; bottom:6px; right:8px; font-size:.8rem; padding:2px 6px; border-radius:999px; background:var(--bg-2) }
.cell.muted { opacity:.35; border-style:dashed }
</style>
```

### `src/routes/calendar/+page.svelte` (Admin tool on top)

```svelte
<script>
  import CalendarMonth from '$lib/calendar/CalendarMonth.svelte';
  import { onMount } from 'svelte';
  let today = new Date();
  let y = today.getFullYear(), m = today.getMonth();
  let adminMode = true; // Admin sees toggle mode
</script>

<section class="card">
  <div class="row" style="justify-content:space-between;align-items:center">
    <h2 style="margin:0">Calendar</h2>
    <div class="row">
      <button class="tag" on:click={()=>{ m--; if(m<0){m=11;y--;} }}>◀</button>
      <div style="min-width:140px;text-align:center;font-weight:700">{y} · {m+1}</div>
      <button class="tag" on:click={()=>{ m++; if(m>11){m=0;y++;} }}>▶</button>
      <button class="tag" on:click={()=> adminMode = !adminMode } aria-pressed={adminMode}>
        {adminMode ? 'Loading Mode: ON' : 'Loading Mode: OFF'}
      </button>
    </div>
  </div>

  <CalendarMonth {year}={y} {month}={m} {adminMode} />
</section>
```

---

# 4) Order Form: with PDF preview, materials, thickness, color systems, loading date

### Minimal color system helper (extend as needed)

### `src/lib/colors/color-systems.ts`

```ts
export type ColorSpec = { system: 'RAL'|'Pantone'|'HEX'|'Other'; code: string; hex?: string; name?: string };

const RAL: Record<string, string> = {
  // extend as needed
  'RAL 9016': '#F6F7F1', 'RAL 9005': '#0A0A0A', 'RAL 3020': '#CC1928',
  'RAL 5005': '#004389', 'RAL 1023': '#F7B500'
};

export function resolveHex(c: ColorSpec): string {
  if (c.system === 'HEX' && /^#?[0-9a-f]{6}$/i.test(c.code)) return c.code.startsWith('#') ? c.code : `#${c.code}`;
  if (c.system === 'RAL' && RAL[c.code]) return RAL[c.code];
  // Pantone mapping omitted; allow manual hex in UI
  return c.hex || '#888888';
}
```

### Color swatch

### `src/lib/colors/ColorSwatch.svelte`

```svelte
<script lang="ts">
  import type { ColorSpec } from './color-systems';
  import { resolveHex } from './color-systems';
  export let color: ColorSpec;
  $: hex = resolveHex(color);
</script>

<div class="sw" aria-label={`${color.system} ${color.code}`}>
  <div class="chip" style={`background:${hex}`}></div>
  <div class="meta">
    <div><b>{color.system}</b> {color.code}</div>
    {#if color.hex && color.system!=='HEX'}<div class="muted">{color.hex}</div>{/if}
  </div>
</div>

<style>
.sw{ display:flex; gap:8px; align-items:center }
.chip{ width:32px; height:24px; border-radius:6px; border:1px solid rgba(0,0,0,.2) }
.meta .muted{ font-size:.85rem }
</style>
```

### Order form (Admin creates/edits)

### `src/lib/order/OrderForm.svelte`

```svelte
<script lang="ts">
  import Input from '$lib/ui/Input.svelte';
  import Button from '$lib/ui/Button.svelte';
  import PdfViewer from '$lib/pdf/PdfViewer.svelte';
  import ColorSwatch from '$lib/colors/ColorSwatch.svelte';
  import { resolveHex, type ColorSpec } from '$lib/colors/color-systems';
  import LoadingDatePicker from '$lib/order/LoadingDatePicker.svelte';
  import { createOrder } from '$lib/order/signage-store';
  import { base } from '$app/paths';

  export let open = false;
  export let onClose: () => void = () => {};

  // Fields
  let id = '';           // PO (unique)
  let title = '';
  let client = '';
  let due = new Date().toISOString().slice(0,10);
  let loadingDate = '';  // from loading dates store
  let pdfPath = '';      // static path for demo (e.g., `${base}/files/PO-...pdf`)

  type MatRow = { key:string; label:string; material:string; thickness:string; color: ColorSpec };
  let materials: MatRow[] = [
    { key:'face', label:'Face', material:'Acrylic', thickness:'3mm', color:{ system:'RAL', code:'RAL 9016' } },
    { key:'back', label:'Back', material:'ACP', thickness:'3mm', color:{ system:'RAL', code:'RAL 9005' } },
    { key:'frame', label:'Face Frame', material:'Aluminum', thickness:'2mm', color:{ system:'Other', code:'Natural' } }
  ];

  function addRow() {
    materials = [...materials, { key:`part_${materials.length+1}`, label:'Part', material:'', thickness:'', color:{ system:'HEX', code:'', hex:'#888888' } }];
  }
  function delRow(i:number){ materials = materials.filter((_,idx)=>idx!==i); }

  function create() {
    if (!id.trim() || !title.trim() || !client.trim() || !pdfPath.trim()) return;
    const fields = [{ key:'due', label:'Due', value: due }, { key:'loading', label:'Loading Date', value: loadingDate || '' }];
    const mats = materials.map(m => ({
      key: m.key,
      label: `${m.label} (${m.material} ${m.thickness})`,
      value: `${m.material} ${m.thickness} – ${m.color.system} ${m.color.code}`
    }));

    createOrder({
      id, title, client, due,
      badges:['OPEN','IN_PROGRESS'],
      fields,
      materials: mats,
      progress:{ CAD:0, CNC:0, SANDING:0, BENDING:0, WELDING:0, PAINT:0, ASSEMBLY:0, QC:0, LOGISTICS:0 },
      file:{ id: crypto.randomUUID(), name: pdfPath.split('/').pop()!, path: pdfPath, kind:'pdf' }
    });

    onClose();
  }
</script>

{#if open}
<div class="shade" on:click={(e)=> e.target===e.currentTarget && onClose()}>
  <div class="panel" role="dialog" aria-modal="true" aria-label="Order form">
    <header><h3>New Order</h3><button class="x" on:click={onClose} aria-label="Close">✕</button></header>

    <section class="grid" style="grid-template-columns:1.2fr 1fr; gap:12px">
      <div class="card">
        <h4>PDF Preview</h4>
        {#if pdfPath}<PdfViewer src={pdfPath} />{:else}<div class="muted">Paste a PDF path under <code>{base}/files/</code></div>}
        <Input bind:value={pdfPath} placeholder={`${base}/files/PO-....pdf`} ariaLabel="PDF path" />
      </div>

      <div class="grid">
        <div class="card">
          <h4>Basics</h4>
          <div class="grid" style="grid-template-columns:1fr 1fr">
            <Input bind:value={id} placeholder="PO number (unique)" />
            <Input bind:value={client} placeholder="Client" />
            <div style="grid-column:span 2"><Input bind:value={title} placeholder="Title" /></div>
            <div>
              <label class="muted">Due</label>
              <input class="rf-input" type="date" bind:value={due} />
            </div>
            <div>
              <label class="muted">Loading Date</label>
              <LoadingDatePicker bind:selected={loadingDate} />
            </div>
          </div>
        </div>

        <div class="card">
          <h4>Colors & Materials</h4>
          <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr auto; gap:8px">
            {#each materials as r, i}
              <Input bind:value={r.label} placeholder="Section" />
              <Input bind:value={r.material} placeholder="Material" />
              <Input bind:value={r.thickness} placeholder="Thickness (e.g., 3mm)" />
              <select class="rf-input" bind:value={r.color.system}>
                <option value="RAL">RAL</option>
                <option value="Pantone">Pantone</option>
                <option value="HEX">HEX</option>
                <option value="Other">Other</option>
              </select>
              <Input bind:value={r.color.code} placeholder="Color code" />
              <div style="grid-column: span 4">
                {#if r.color.system === 'HEX'}
                  <Input bind:value={r.color.code} placeholder="#RRGGBB" />
                {:else}
                  <Input bind:value={r.color.hex} placeholder="Optional HEX override" />
                {/if}
              </div>
              <div class="row" style="align-items:center; gap:6px">
                <ColorSwatch color={r.color} />
                <button class="tag" on:click={()=> delRow(i)} aria-label="Remove">–</button>
              </div>
            {/each}
            <div style="grid-column:1 / -1"><button class="tag" on:click={addRow}>+ Add section</button></div>
          </div>
        </div>
      </div>
    </section>

    <footer class="row" style="justify-content:flex-end; gap:8px; margin-top:10px">
      <Button variant="ghost" on:click={onClose}>Cancel</Button>
      <Button on:click={create}>Create Order</Button>
    </footer>
  </div>
</div>
{/if}

<style>
.shade{position:fixed;inset:0;background:rgba(0,0,0,.45);display:grid;place-items:center;z-index:99}
.panel{background:var(--bg-1);border:1px solid rgba(255,255,255,.12);border-radius:14px;min-width:920px;max-width:95vw;max-height:90vh;padding:14px;overflow:auto}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.x{background:transparent;border:none;color:var(--text);cursor:pointer;font-size:1.1rem}
</style>
```

### Loading Date picker for the form

### `src/lib/order/LoadingDatePicker.svelte`

```svelte
<script lang="ts">
  import { upcoming, usage } from '$lib/loading/loading-store';
  import { onMount } from 'svelte';
  export let selected = '';
  let opts: { value:string; label:string; full:boolean }[] = [];
  function refresh() {
    opts = upcoming().map(d => {
      const u = usage(d.date);
      return { value:d.date, label:`${d.date} · ${u.assigned}/${u.capacity || '∞'}`, full: u.full };
    });
  }
  onMount(refresh); $: refresh(); // recompute on every render (cheap)
</script>

<select class="rf-input" bind:value={selected} aria-label="Loading date">
  <option value="">—</option>
  {#each opts as o}
    <option value={o.value} disabled={o.full}>{o.label}</option>
  {/each}
</select>
```

---

# 5) Hook Order Form into Orders page (Admin)

Add a button to open the new form (replace your old wizard if you like).

### `src/routes/orders/+page.svelte` (snippet)

```svelte
<script>
  import OrderForm from '$lib/order/OrderForm.svelte';
  let formOpen = false;
</script>

<section class="card">
  <div class="row" style="justify-content:space-between">
    <h2 style="margin:0">Orders</h2>
    <button class="tag" on:click={()=> formOpen = true}>New Order</button>
  </div>
  <!-- your existing orders table/list -->
</section>

<OrderForm bind:open={formOpen} onClose={() => formOpen=false} />
```

---

# 6) Nice extras (capacity planning & badges)

* **Calendar Month** shows assigned/capacity “X/Y” on each marked Loading Day.
* If you’d like visual fill, add a tiny bar:

```css
/* Add to CalendarMonth.svelte */
.cell[data-active="true"]::after{
  content:"";
  position:absolute; left:0; right:0; bottom:0; height:4px;
  background: linear-gradient(90deg, var(--brand-amber), var(--brand-cyan));
  transform-origin:left;
  transform: scaleX(var(--fill,1));
}
```

```svelte
<!-- compute fill and set style; inside button -->
<button class="cell" style={`--fill:${meta(d.iso).capacity ? (meta(d.iso).assigned / meta(d.iso).capacity) : 0};`}
  ...>
```

---

# 7) i18n keys (add to your locale files)

Append to `en.json`:

```json
{
  "calendar": {
    "title": "Calendar",
    "loading_mode": "Loading Mode",
    "capacity": "Capacity",
    "note": "Note",
    "loading_day": "Loading day"
  },
  "orderform": {
    "title": "New Order",
    "pdf": "PDF Preview",
    "basics": "Basics",
    "materials": "Colors & Materials",
    "po": "PO number (unique)",
    "client": "Client",
    "order_title": "Title",
    "due": "Due",
    "loading": "Loading Date",
    "add_section": "Add section",
    "create": "Create Order"
  }
}
```

…and mirror to `ru.json` / `lv.json` (translations per your style).

---

## How the workflow feels

1. **Admin** opens **Calendar** → toggles **Loading Mode** → clicks a day to mark it → sets capacity/notes.
2. **Admin** opens **New Order** form → fills basics → **selects a Loading Date** from upcoming (disabled if full) → defines materials/colors (with **visual swatches** and codes) → pastes PDF path → **Create Order**.
3. The order page then shows:

   * PDF preview (from attached path)
   * Materials with thickness + color system/code + actual swatch
   * “Loading Date” in fields, and you can display it in the header/badges if you like
4. Capacity and assignment counts update **automatically** (derived from order snapshots).

---

If you want, I can follow up with:

* “Assign/Change Loading Date” on existing orders (Admin button → picker)
* Calendar view: list orders scheduled for a selected Loading Day
* Export of Loading Day manifest (CSV/PDF for logistics)
* Color code validators (HEX pattern; popular RAL quick-list)
* Real file uploads when you introduce a backend

Want me to package this as a PR patch?
